import { NextResponse } from 'next/server';

export const dynamic = 'force-dynamic';

// โโโ ุชุนุฑูู ุงูุฃุนูุฏุฉ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
const COLUMNS = [
  {
    ar:       'ุงุณู ุงููุชุฌุฑ *',
    en:       'store_name',
    required: true,
    note:     'ุงุณู ุงููุชุฌุฑ ููุง ูุธูุฑ ููุนููุงุก โ ุฅุฐุง ุชูุฑู ูุงุฑุบุงู ุณููุฌูุจ ุชููุงุฆูุงู ูู ุงููููุน',
    examples: ['ูุชุฌุฑ ุงูููุฑ', 'ุจูุชูู ุณุงุฑุฉ', 'ููุชุจุฉ ุงูุนูู'],
    values:   '',
  },
  {
    ar:       'ุฑุงุจุท ุงููุชุฌุฑ *',
    en:       'store_url',
    required: true,
    note:     'ุงูุฑุงุจุท ุงูุฃุณุงุณู ูููุชุฌุฑ โ ููุณุชุฎุฏู ูููุชุงุญ ุชุญุฏูุซ (ูุง ุชูุฑุฑ ููุณ ุงูุฑุงุจุท)',
    examples: ['mystore.com', 'store.salla.sa/myshop', 'zid.store/mystore'],
    values:   '',
  },
  {
    ar:       'ุงุณู ุตุงุญุจ ุงููุชุฌุฑ',
    en:       'owner_name',
    required: false,
    note:     'ุงูุงุณู ุงููุงูู ูุตุงุญุจ ุงููุชุฌุฑ',
    examples: ['ูุญูุฏ ุฃุญูุฏ ุงูุนูุฑู', 'ุณุงุฑุฉ ุฎุงูุฏ'],
    values:   '',
  },
  {
    ar:       'ุฑูู ุงูุฌูุงู *',
    en:       'owner_phone',
    required: true,
    note:     'ุฑูู ุงูุฌูุงู ุงูุณุนูุฏู โ ููุจู: 05XXXXXXXX ุฃู +9665XXXXXXXX ุฃู 5XXXXXXXX',
    examples: ['0501234567', '+966501234567', '501234567'],
    values:   '',
  },
  {
    ar:       'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู',
    en:       'owner_email',
    required: false,
    note:     'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุตุงุญุจ ุงููุชุฌุฑ',
    examples: ['owner@store.com', 'info@myshop.sa'],
    values:   '',
  },
  {
    ar:       'ุงูุฃููููุฉ',
    en:       'priority',
    required: false,
    note:     'ุฃููููุฉ ุงููุชุฌุฑ ูู ุงููุชุงุจุนุฉ',
    examples: ['ุนุงูู', 'ูุชูุณุท', 'ููุฎูุถ'],
    values:   'ุนุงูู | ูุชูุณุท | ููุฎูุถ',
  },
  {
    ar:       'ุงูุญุงูุฉ',
    en:       'status',
    required: false,
    note:     'ุงูุญุงูุฉ ุงูุญุงููุฉ ูููุชุฌุฑ',
    examples: ['ูุดุท', 'ูุชููู', 'ุฌุฏูุฏ', 'ููุชูู'],
    values:   'ุฌุฏูุฏ | ูุดุท | ูุชููู | ููุชูู',
  },
  {
    ar:       'ุงูููุฒุงููุฉ',
    en:       'budget',
    required: false,
    note:     'ุงูููุฒุงููุฉ ุงูุดูุฑูุฉ ุจุงูุฑูุงู โ ุฃุฑูุงู ููุท ุจุฏูู ุฑููุฒ',
    examples: ['5000', '25000', 'ูกูููู'],
    values:   'ุฑูู (ูุซุงู: 5000)',
  },
  {
    ar:       'ุงูุชุตููู',
    en:       'category',
    required: false,
    note:     'ุชุตููู ุฃู ูุทุงุน ุงููุชุฌุฑ',
    examples: ['ููุงุจุณ', 'ุฅููุชุฑูููุงุช', 'ูุณุชูุฒูุงุช ููุฒููุฉ', 'ุนุทูุฑ'],
    values:   '',
  },
  {
    ar:       'ุฑุงุจุท ูุฑูุจ ุงููุชุฌุฑ',
    en:       'store_group_url',
    required: false,
    note:     'ุฑุงุจุท ูุฌููุนุฉ ูุงุชุณุงุจ ุฃู ุชูููุฌุฑุงู ุงูุฎุงุตุฉ ุจุงููุชุฌุฑ',
    examples: ['https://chat.whatsapp.com/xxx', 'https://t.me/xxx'],
    values:   '',
  },
  {
    ar:       'ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุงุดุชุฑุงู',
    en:       'subscription_start_date',
    required: false,
    note:     'ุชุงุฑูุฎ ุจุฏุก ุงูุงุดุชุฑุงู โ ููุจู: YYYY-MM-DD ุฃู DD/MM/YYYY',
    examples: ['2025-01-15', '15/01/2025', '2025/06/01'],
    values:   'YYYY-MM-DD ุฃู DD/MM/YYYY',
  },
  {
    ar:       'ูุฏูุฑ ุงูุญุณุงุจ',
    en:       'account_manager_id',
    required: false,
    note:     'UUID ููุฏูุฑ ุงูุญุณุงุจ ูู ุฌุฏูู ุงููุณุชุฎุฏููู โ ุงุชุฑูู ูุงุฑุบุงู ุฅุฐุง ูู ุชุนุฑูู',
    examples: ['xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'],
    values:   'UUID (ูุซุงู: a1b2c3d4-...)',
  },
  {
    ar:       'ุงูููุฏูุง ุจุงูุฑ',
    en:       'media_buyer_id',
    required: false,
    note:     'UUID ููููุฏูุง ุจุงูุฑ ูู ุฌุฏูู ุงููุณุชุฎุฏููู โ ุงุชุฑูู ูุงุฑุบุงู ุฅุฐุง ูู ุชุนุฑูู',
    examples: ['xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'],
    values:   'UUID (ูุซุงู: a1b2c3d4-...)',
  },
  {
    ar:       'ููุงุญุธุงุช',
    en:       'notes',
    required: false,
    note:     'ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ ุนู ุงููุชุฌุฑ',
    examples: ['ูุชุฌุฑ ุฌุฏูุฏ ูุญุชุงุฌ ูุชุงุจุนุฉ', 'ุชู ุงูุชูุงุตู ูุน ุงููุงูู'],
    values:   '',
  },
] as const;

// โโโ ุจูุงูุงุช ูุซุงู (3 ูุชุงุฌุฑ) โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
const EXAMPLE_ROWS = [
  ['ูุชุฌุฑ ุงูููุฑ',     'alnoor-store.com',      'ูุญูุฏ ุฃุญูุฏ',   '0501234567', 'mohammed@alnoor.com', 'ุนุงูู',   'ูุดุท',   '8000',  'ููุงุจุณ',        'https://chat.whatsapp.com/xxx', '2025-01-15', '', '', 'ูุชุฌุฑ ูููุฒ'],
  ['ุจูุชูู ุณุงุฑุฉ',    'sara-boutique.salla.sa', 'ุณุงุฑุฉ ุฎุงูุฏ',   '0559876543', 'sara@boutique.com',   'ูุชูุณุท',  'ูุดุท',   '5000',  'ุฃุฒูุงุก ูุณุงุฆูุฉ', '',                             '2025-03-01', '', '', ''],
  ['ููุชุจุฉ ุงูููุฑ',   'alfekr-books.com',       'ุนุจุฏุงููู ุนูู', '0531112233', '',                    'ููุฎูุถ',  'ุฌุฏูุฏ',  '3000',  'ูุชุจ',          '',                             '',           '', '', 'ูู ูุชู ุงูุชูุงุตู ุจุนุฏ'],
];

export async function GET() {
  try {
    const XLSX = await import('xlsx');
    const wb = XLSX.utils.book_new();

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // Sheet 1: ุงููุชุงุฌุฑ
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    const arHeaders = COLUMNS.map(c => c.ar);

    const wsRows = [arHeaders, ...EXAMPLE_ROWS];
    const ws1 = XLSX.utils.aoa_to_sheet(wsRows);

    // ุนุฑุถ ุงูุฃุนูุฏุฉ
    ws1['!cols'] = [
      { wch: 20 }, // ุงุณู ุงููุชุฌุฑ
      { wch: 30 }, // ุฑุงุจุท ุงููุชุฌุฑ
      { wch: 20 }, // ุงุณู ุตุงุญุจ ุงููุชุฌุฑ
      { wch: 16 }, // ุฑูู ุงูุฌูุงู
      { wch: 26 }, // ุงูุจุฑูุฏ
      { wch: 12 }, // ุงูุฃููููุฉ
      { wch: 12 }, // ุงูุญุงูุฉ
      { wch: 12 }, // ุงูููุฒุงููุฉ
      { wch: 18 }, // ุงูุชุตููู
      { wch: 30 }, // ุฑุงุจุท ุงููุฑูุจ
      { wch: 22 }, // ุชุงุฑูุฎ ุงูุงุดุชุฑุงู
      { wch: 36 }, // ูุฏูุฑ ุงูุญุณุงุจ
      { wch: 36 }, // ุงูููุฏูุง ุจุงูุฑ
      { wch: 28 }, // ููุงุญุธุงุช
    ];

    // ุชุฌููุฏ ุงูุตู ุงูุฃูู
    ws1['!freeze'] = { xSplit: 0, ySplit: 1 };

    XLSX.utils.book_append_sheet(wb, ws1, 'ุงููุชุงุฌุฑ');

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // Sheet 2: ุชุนูููุงุช
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    const instrRows: (string | number)[][] = [
      // ุนููุงู
      ['๐ ุชุนูููุงุช ุงุณุชุฎุฏุงู ูุงูุจ ุงุณุชูุฑุงุฏ ุงููุชุงุฌุฑ'],
      [''],
      // ูุณู: ูุนูููุงุช ุนุงูุฉ
      ['โน๏ธ ูุนูููุงุช ุนุงูุฉ'],
      ['โข ูุฐุง ุงููุงูุจ ูุงุจู ูุฅุนุงุฏุฉ ุงูุฑูุน ูู ุฃู ููุช โ ุงููุธุงู ููุญุฏูุซ ุงููุชุงุฌุฑ ุงูููุฌูุฏุฉ ุชููุงุฆูุงู'],
      ['โข ุฑุงุจุท ุงููุชุฌุฑ (store_url) ูู ุงูููุชุงุญ ุงูุฃุณุงุณู โ ูุง ุชูุฑุฑ ููุณ ุงูุฑุงุจุท ูู ุงูููู'],
      ['โข ุงูุญููู ุงูููุนูููุฉ ุจู * ูุทููุจุฉุ ุงูุจุงูู ุงุฎุชูุงุฑู'],
      ['โข ูููู ุฑูุน ุงูููู ุจุฃุนูุฏุฉ ุนุฑุจูุฉ ุฃู ุฅูุฌููุฒูุฉ ุฃู ูุฒูุฌ ููููุง'],
      [''],
      // ุฌุฏูู ุงูุญููู
      ['๐ ุชูุงุตูู ุงูุญููู'],
      ['ุงูุนููุฏ', 'ุงูุงุณู ุงูุฅูุฌููุฒู', 'ูุทููุจุ', 'ุงูููู ุงูููุจููุฉ', 'ุฃูุซูุฉ', 'ููุงุญุธุงุช'],
      ...COLUMNS.map(c => [
        c.ar,
        c.en,
        c.required ? 'โ ูุนู' : 'โ ูุง',
        c.values || 'ูุต ุญุฑ',
        c.examples.join(' | '),
        c.note,
      ]),
      [''],
      // ูุณู: ุงูุชุตุญูุญ ุงูุชููุงุฆู
      ['๐ง ุงูุชุตุญูุญ ุงูุชููุงุฆู (ูุทุจููู ุงููุธุงู ุชููุงุฆูุงู)'],
      ['โข ุฑูู ุงูุฌูุงู: +9665XXXXXXXX ุฃู 5XXXXXXXX โ ููุญูููู ุชููุงุฆูุงู ุฅูู 05XXXXXXXX'],
      ['โข ุฑุงุจุท ุงููุชุฌุฑ: https://www.mystore.com/ โ mystore.com (ุชูุธูู ุชููุงุฆู)'],
      ['โข ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ: ูกูขูฃูคูฅ โ 12345'],
      ['โข ุงูููุฒุงููุฉ: "25,000" ุฃู "ูขูฅููู" โ 25000'],
      ['โข ุงูุชุงุฑูุฎ: 15/01/2025 โ 2025-01-15'],
      ['โข ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: ููุญูููู ุฅูู ุญุฑูู ุตุบูุฑุฉ ุชููุงุฆูุงู'],
      [''],
      // ูุณู: ูุดู ุงูุชูุฑุงุฑ
      ['๐ ูุดู ุงูุชูุฑุงุฑ (Dedup)'],
      ['โข ุฅุฐุง ููุฌุฏ ูุชุฌุฑ ุจููุณ ุฑุงุจุท ุงููุชุฌุฑ โ ููุญุฏููุซ (ูุง ููุถุงู ููุฑุฑ)'],
      ['โข ุฅุฐุง ููุฌุฏ ูุชุฌุฑ ุจููุณ ุฑูู ุงูุฌูุงู โ ููุญุฏููุซ'],
      ['โข ุฅุฐุง ููุฌุฏ ูุชุฌุฑ ุจููุณ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู โ ููุญุฏููุซ'],
      ['โข ุงูุฃููููุฉ: ุฑุงุจุท ุงููุชุฌุฑ > ุฑูู ุงูุฌูุงู > ุงูุจุฑูุฏ ุงูุฅููุชุฑููู'],
      [''],
      // ูุณู: ุงูุฃููููุฉ ูุงูุญุงูุฉ
      ['๐ ุงูููู ุงูููุจููุฉ ููุฃููููุฉ ูุงูุญุงูุฉ'],
      ['ุงูุฃููููุฉ:', 'ุนุงูู', 'ูุชูุณุท', 'ููุฎูุถ', '(ุฃู: high, medium, low)'],
      ['ุงูุญุงูุฉ:',   'ุฌุฏูุฏ', 'ูุดุท',   'ูุชููู',  'ููุชูู', '(ุฃู: new, active, paused, expired)'],
      [''],
      // ุชูุจูู
      ['โ๏ธ ุชูุจููุงุช ูููุฉ'],
      ['โข ูุง ุชุญุฐู ุตู ุงูุชุฑููุณุฉ (ุงูุตู ุงูุฃูู)'],
      ['โข ูุง ุชุบููุฑ ุฃุณูุงุก ุงูุฃุนูุฏุฉ โ ุงููุธุงู ูุชุนุฑู ุนูููุง ุชููุงุฆูุงู'],
      ['โข ูููู ุฅุถุงูุฉ ุฃุนูุฏุฉ ุฅุถุงููุฉ โ ุณูุชุฌุงูููุง ุงููุธุงู'],
      ['โข ุงูููู ูุฏุนู: xlsx, xls, csv, tsv'],
    ];

    const ws2 = XLSX.utils.aoa_to_sheet(instrRows);
    ws2['!cols'] = [
      { wch: 30 }, // ุงูุนููุฏ
      { wch: 26 }, // ุงูุงุณู ุงูุฅูุฌููุฒู
      { wch: 12 }, // ูุทููุจ
      { wch: 30 }, // ุงูููู
      { wch: 40 }, // ุฃูุซูุฉ
      { wch: 55 }, // ููุงุญุธุงุช
    ];

    // ุฏูุฌ ุฎููุฉ ุงูุนููุงู
    ws2['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }];

    XLSX.utils.book_append_sheet(wb, ws2, 'ุชุนูููุงุช');

    // โโ ุชูููุฏ ุงูููู โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    const buf = XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' });

    return new NextResponse(buf, {
      status: 200,
      headers: {
        'Content-Type':        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'Content-Disposition': 'attachment; filename*=UTF-8\'\'%D9%82%D8%A7%D9%84%D8%A8-%D8%A7%D8%B3%D8%AA%D9%8A%D8%B1%D8%A7%D8%AF-%D8%A7%D9%84%D9%85%D8%AA%D8%A7%D8%AC%D8%B1.xlsx',
      },
    });

  } catch (err: any) {
    return NextResponse.json({ error: err.message }, { status: 500 });
  }
}
